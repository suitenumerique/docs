"""Malware detection callbacks"""

import logging

from django.core.files.storage import default_storage
from django.db import transaction

from lasuite.malware_detection.enums import ReportStatus

from core.enums import DocumentAttachmentStatus
from core.models import Document, OutlineImportJob

logger = logging.getLogger(__name__)
security_logger = logging.getLogger("docs.security")


def malware_detection_callback(file_path, status, error_info, **kwargs):
    """Malware detection callback"""

    # Handle Outline import jobs
    import_job_id = kwargs.get("import_job_id")
    if import_job_id:
        _handle_outline_import_scan(import_job_id, file_path, status, error_info)
        return

    # Handle regular document attachments
    if status == ReportStatus.SAFE:
        logger.info("File %s is safe", file_path)
        # Get existing metadata
        s3_client = default_storage.connection.meta.client
        bucket_name = default_storage.bucket_name
        head_resp = s3_client.head_object(Bucket=bucket_name, Key=file_path)
        metadata = head_resp.get("Metadata", {})
        metadata.update({"status": DocumentAttachmentStatus.READY})
        # Update status in metadata
        s3_client.copy_object(
            Bucket=bucket_name,
            CopySource={"Bucket": bucket_name, "Key": file_path},
            Key=file_path,
            ContentType=head_resp.get("ContentType"),
            Metadata=metadata,
            MetadataDirective="REPLACE",
        )
        return

    document_id = kwargs.get("document_id")
    security_logger.warning(
        "File %s for document %s is infected with malware. Error info: %s",
        file_path,
        document_id,
        error_info,
    )

    # Remove the file from the document and change the status to unsafe
    document = Document.objects.get(pk=document_id)
    document.attachments.remove(file_path)
    document.save(update_fields=["attachments"])

    # Delete the file from the storage
    default_storage.delete(file_path)


def _handle_outline_import_scan(job_id, file_path, status, error_info):
    """Handle malware scan result for Outline import zip files."""
    from core.tasks.outline_import import process_outline_import_task

    try:
        job = OutlineImportJob.objects.get(id=job_id)
    except OutlineImportJob.DoesNotExist:
        logger.error("OutlineImportJob %s not found for malware callback", job_id)
        return

    if status == ReportStatus.SAFE:
        logger.info("Outline import zip %s is safe, triggering import task", file_path)
        job.status = OutlineImportJob.Status.SCANNING
        job.save(update_fields=["status", "updated_at"])

        # Trigger the import task after the current transaction commits
        # This ensures the status update is visible to the task
        transaction.on_commit(lambda: process_outline_import_task.delay(str(job.id)))
    else:
        security_logger.warning(
            "Outline import zip %s contains malware. Job %s marked as failed. Error: %s",
            file_path,
            job_id,
            error_info,
        )
        job.status = OutlineImportJob.Status.FAILED
        job.error_message = f"Malware detected in uploaded file: {error_info}"
        job.save(update_fields=["status", "error_message", "updated_at"])

        # Delete the infected zip file
        try:
            default_storage.delete(file_path)
        except Exception as e:
            logger.warning("Failed to delete infected zip file %s: %s", file_path, e)
